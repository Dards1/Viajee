<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Pinboard ‚Äì Florian√≥polis</title>
  <meta name="description" content="Simple collaborative-style pinboard for planning a trip. Add cars, hotels, transport, and plans with title, price, image and link. Local-only (no server)." />
  <style>
    :root{
      --bg: #0f1220;        /* deep indigo */
      --card: #171a2b;      /* slightly lighter */
      --muted: #9aa4b2;
      --text: #f5f7fb;
      --accent: #54d2d2;    /* teal */
      --accent-2: #a882ff;  /* violet */
      --danger: #ff6b6b;
      --ok: #63e6be;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 80% -100px, rgba(168,130,255,.25), transparent 60%),
                  radial-gradient(900px 500px at -20% -60px, rgba(84,210,210,.20), transparent 60%), var(--bg);
      color: var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      position: sticky; top:0; z-index:5;
      backdrop-filter: blur(8px);
      background: linear-gradient( to bottom, rgba(15,18,32,.85), rgba(15,18,32,.55) );
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px; margin:0 auto; padding: 16px 18px}
    .topbar{display:flex; align-items:center; gap:14px; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display:grid; place-items:center; color:#0b0d16; font-weight:800
    }
    .title{font-weight:800; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:.92rem}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .chip{
      padding:8px 12px; border-radius: 999px; font-weight:600;
      background: #1b1f31; color:#cdd6e5; border:1px solid rgba(255,255,255,.06)
    }

    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{
      padding:12px 18px; border-radius: 999px; border:1px solid rgba(255,255,255,.08);
      background:#13182a; color:#dfe6f5; cursor:pointer; font-weight:800;
      transition:.2s transform; user-select:none; font-size:1.05rem;
    }
    /* Make Cars / Hotels / Transport bigger */
    .tab[data-id="cars"], .tab[data-id="hotels"], .tab[data-id="transport"]{
      font-size:1.25rem; padding:14px 22px;
    }
    .tab.active, .tab[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(84,210,210,.30), rgba(168,130,255,.30));
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 8px 22px rgba(0,0,0,.45), 0 0 0 2px rgba(84,210,210,.12) inset;
      outline: 0;
    }
    .tab:active{transform:scale(.98)}

    .panel{
      margin:18px auto; background: rgba(19,24,42,.65); border:1px solid rgba(255,255,255,.07);
      border-radius: var(--radius-xl); padding: 18px; box-shadow: var(--shadow);
    }
    .grid{
      display:grid; grid-template-columns: repeat( auto-fill, minmax(240px, 1fr) ); gap:16px;
    }
    .card{
      position:relative; overflow:hidden; border-radius: var(--radius-lg);
      background: var(--card); border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }
    .card.dragging{opacity:.6; outline:2px dashed rgba(255,255,255,.25)}
    .thumb{
      width:100%; aspect-ratio: 16/10; background:#0c0f1a; display:block; object-fit:cover
    }
    .content{padding:12px 14px}
    .price{font-weight:800; font-size:1.05rem}
    .note{color:var(--muted); font-size:.92rem; margin-top:4px}
    .meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px}
    .btns{display:flex; gap:8px}
    button, .btn{
      appearance:none; border:1px solid rgba(255,255,255,.10); background:#11162a;
      color:#e8eefc; padding:9px 12px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    button:hover,.btn:hover{border-color: rgba(255,255,255,.22)}
    .btn-ghost{background:transparent}
    .btn-danger{background:#201316; border-color:#3a1d25; color:#ff9aa0}
    .btn-accent{background:linear-gradient(135deg, rgba(84,210,210,.2), rgba(168,130,255,.2)); border-color: rgba(255,255,255,.18)}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-top:10px}
    .toolbar .left, .toolbar .right{display:flex; gap:10px; flex-wrap:wrap}
    .pill-input{display:flex; align-items:center; gap:8px; background:#0e1222; border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:8px 12px}
    .pill-input input{background:transparent; border:none; outline:none; color:#fff; min-width:120px}
    .pill-input input::placeholder{color:#8390a3}
    .form{display:grid; grid-template-columns: repeat(2, minmax(160px, 1fr)); gap:10px; margin-top:10px}
    .form .wide{grid-column: 1 / -1}

    .footer{opacity:.8; color:var(--muted); font-size:.9rem; text-align:center; margin:40px 0}
    .empty{color:var(--muted); text-align:center; padding:22px}
    .like{cursor:pointer; user-select:none}
    .tag{font-size:.78rem; padding:4px 8px; border-radius:999px; background:#1e2236; color:#cdd6e5; border:1px solid rgba(255,255,255,.06)}

    @media (max-width:640px){
      .form{grid-template-columns: 1fr}
      .hide-sm{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <div class="logo">‚úà</div>
        <div>
          <div class="title">Trip Pinboard ‚Äì Florian√≥polis</div>
          <div class="subtitle">Pin options with title ¬∑ price ¬∑ image ¬∑ link. Local-only (saved in your browser).</div>
        </div>
      </div>
      <div class="row hide-sm">
        <span class="chip">No login</span>
        <span class="chip">LocalStorage</span>
        <!-- removed Export / Import chip -->
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Tabs -->
    <div class="panel">
      <div class="tabs" id="tabs"></div>
      <div class="toolbar">
        <div class="left">
          <div class="pill-input"><span>üîé</span><input id="search" placeholder="Filter by title or note‚Ä¶"></div>
          <button class="btn" id="sortPrice">Sort by price</button>
          <button class="btn" id="sortTitle">Sort by title</button>
        </div>
        <div class="right">
          <!-- Export/Import removed -->
          <button class="btn-ghost" id="demoBtn">Load demo</button>
          <button class="btn-danger" id="clearBtn">Clear all</button>
        </div>
      </div>

      <!-- Add form -->
      <section class="form" id="addForm">
        <div class="pill-input"><span>üìù</span><input id="title" placeholder="Title (e.g., Fiat Argo or Hotel XYZ)" /></div>
        <div class="pill-input"><span>üí≤</span><input id="price" placeholder="Price (e.g., 150 USD)" /></div>
        <div class="pill-input wide"><span>üîó</span><input id="link" placeholder="Link (https://‚Ä¶)" /></div>
        <div class="pill-input wide"><span>üñºÔ∏è</span><input id="image" placeholder="Image URL (https://‚Ä¶)" /></div>
        <div class="pill-input wide"><span>üóíÔ∏è</span><input id="note" placeholder="Notes (optional)" /></div>
        <div style="display:flex; gap:10px; align-items:center">
          <button id="addBtn">Add to <span id="addCatLabel"></span></button>
          <label class="pill-input"><span>üè∑Ô∏è</span><input id="tag" placeholder="Tag (optional: e.g., refundable, 4pax)"></label>
        </div>
      </section>
    </div>

    <!-- Cards grid -->
    <section class="panel">
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none">Nothing here yet. Add your first card above ‚ú®</div>
    </section>

    <div class="footer">Built for friends planning a trip to Floripa.</div>
  </main>
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // ‚¨áÔ∏è TUS CREDENCIALES
  const SUPABASE_URL = 'https://sgoegodfbqicmllblllq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnb2Vnb2RmYnFpY21sbGJsbGxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTMyNDUsImV4cCI6MjA3ODA4OTI0NX0.X2v2WGewNrz5UWipDhYU51lNWyIFueSs-y3jipDx3SA';

  // Tablero p√∫blico (sin login)
  const BOARD_ID = 'viaje-floripa';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const DEFAULT_CATEGORIES = [
    { id:'cars', name:'Cars' },
    { id:'hotels', name:'Hotels' },
    { id:'transport', name:'Transport to Floripa' },
    { id:'plans', name:'Plans & Ideas' },
  ];

  // ====== UI refs ======
  const tabsEl = document.getElementById('tabs');
  const gridEl = document.getElementById('grid');
  const emptyEl = document.getElementById('empty');

  const titleEl = document.getElementById('title');
  const priceEl = document.getElementById('price');
  const linkEl  = document.getElementById('link');
  const imageEl = document.getElementById('image');
  const noteEl  = document.getElementById('note');
  const tagEl   = document.getElementById('tag');

  const addBtn = document.getElementById('addBtn');
  const addCatLabel = document.getElementById('addCatLabel');

  const searchEl = document.getElementById('search');
  const sortPriceBtn = document.getElementById('sortPrice');
  const sortTitleBtn = document.getElementById('sortTitle');

  const demoBtn = document.getElementById('demoBtn');
  const clearBtn = document.getElementById('clearBtn');

  // ====== Estado ======
  let state = { categories: DEFAULT_CATEGORIES, items: { cars:[], hotels:[], transport:[], plans:[] } };
  let currentCat = 'cars';
  let searchQuery = '';
  let sortMode = null; // 'price' | 'title' | null

  // ====== Init ======
  renderTabs();
  await initialLoad();
  subscribeRealtime();

  // ====== Handlers ======
  addBtn.addEventListener('click', async () => {
    const item = toRow({
      category: currentCat,
      title: titleEl.value.trim(),
      price: priceEl.value.trim(),
      link: linkEl.value.trim(),
      image: imageEl.value.trim(),
      note: noteEl.value.trim(),
      tag: tagEl.value.trim()
    });
    if(!item.title){ alert('Please add a title'); return; }
    if(item.image && !isValidUrl(item.image)){
      if(!confirm('Image URL looks invalid. Add anyway?')) return;
    }
    if(item.link && !isValidUrl(item.link)){
      if(!confirm('Link looks invalid. Add anyway?')) return;
    }
    const { error } = await supabase.from('items').insert(item);
    if(error){ alert('Could not add: ' + error.message); return; }
    clearForm();
  });

  searchEl.addEventListener('input', () => { searchQuery = searchEl.value.toLowerCase(); render(); });
  sortPriceBtn.addEventListener('click', () => { sortMode = 'price'; render(); });
  sortTitleBtn.addEventListener('click', () => { sortMode = 'title'; render(); });

  demoBtn.addEventListener('click', async () => {
    if(!confirm('Load demo cards into the SHARED board?')) return;
    const sample = [
      {category:'cars', title:'Fiat Argo (Localiza)', price:'R$ 210/d√≠a', link:'https://www.localiza.com/'},
      {category:'cars', title:'Chevrolet Onix (Movida)', price:'R$ 230/d√≠a', link:'https://www.movida.com.br/'},
      {category:'hotels', title:'Jurer√™ Hotel', price:'R$ 680/noche', link:'#'},
      {category:'transport', title:'Vuelos MVD‚ÜíFLN (AZUL)', price:'US$ 350 ida', link:'#'},
      {category:'plans', title:'Praia Mole', price:'gratis', link:'#'},
    ].map(toRow);
    await supabase.from('items').insert(sample);
  });

  clearBtn.addEventListener('click', async () => {
    if(confirm('Delete ALL cards from the SHARED board?')){
      await supabase.from('items').delete().eq('board_id', BOARD_ID);
    }
  });

  // ====== Data layer ======
  function toRow(x){
    return {
      id: crypto.randomUUID(),
      board_id: BOARD_ID,
      category: (x.category||'cars').toLowerCase(),
      title: (x.title||'').trim(),
      price: (x.price||'').trim(),
      link: (x.link||'').trim(),
      image: (x.image||'').trim(),
      note: (x.note||'').trim(),
      tag: (x.tag||'').trim(),
      likes: x.likes ?? 0,
      position: x.position ?? Date.now()
    };
  }

  async function initialLoad(){
    const { data, error } = await supabase
      .from('items')
      .select('*')
      .eq('board_id', BOARD_ID)
      .order('category', { ascending: true })
      .order('position', { ascending: true })
      .order('created_at', { ascending: true });
    if(error){ console.error(error); return; }
    state.items = { cars:[], hotels:[], transport:[], plans:[] };
    for(const r of data){ (state.items[(r.category||'').toLowerCase()] ||= []).push(r); }
    render();
  }

  // Realtime without server-side filter; client-guarded by board_id.
  function subscribeRealtime(){
    supabase
      .channel('items')
      .on('postgres_changes', { event:'*', schema:'public', table:'items' }, payload => {
        const row = payload.new ?? payload.old;
        if(row?.board_id !== BOARD_ID) return; // ignore other boards
        applyChange(payload);
        render();
      })
      .subscribe();
  }

  function applyChange({ new: nv, old: ov }){
    if(ov){
      const ok = (ov.category||'').toLowerCase();
      state.items[ok] = (state.items[ok]||[]).filter(i => i.id !== ov.id);
    }
    if(nv){
      const nk = (nv.category||'').toLowerCase();
      const arr = (state.items[nk] ||= []);
      const i = arr.findIndex(x => x.id === nv.id);
      if(i>-1) arr[i] = nv; else arr.push(nv);
      arr.sort((a,b)=> (a.position||0)-(b.position||0) || (new Date(a.created_at)-new Date(b.created_at)));
    }
  }

  // ====== UI ======
  function renderTabs(){
    tabsEl.innerHTML = '';
    state.categories.forEach(cat => {
      const el = document.createElement('button');
      el.className = 'tab' + (cat.id===currentCat ? ' active':'' );
      el.textContent = cat.name;
      el.dataset.id = cat.id;
      el.setAttribute('aria-selected', String(cat.id===currentCat));
      tabsEl.appendChild(el);
    });
    // Delegated click so handlers never get lost
    if(!tabsEl.__bound){
      tabsEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.tab');
        if(!btn) return;
        const id = btn.dataset.id;
        if(!id || id===currentCat) return;
        currentCat = id;
        for(const b of tabsEl.querySelectorAll('.tab')){
          const isSel = b.dataset.id===currentCat;
          b.classList.toggle('active', isSel);
          b.setAttribute('aria-selected', String(isSel));
        }
        addCatLabel.textContent = state.categories.find(c=>c.id===currentCat)?.name || '';
        render();
      });
      tabsEl.__bound = true;
    }
    addCatLabel.textContent = state.categories.find(c=>c.id===currentCat)?.name || '';
  }

  function render(){
    const items = [...(state.items[currentCat]||[])];
    const filtered = items.filter(x =>
      !searchQuery ||
      (x.title||'').toLowerCase().includes(searchQuery) ||
      (x.note||'').toLowerCase().includes(searchQuery)
    );
    if(sortMode==='title') filtered.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
    if(sortMode==='price') filtered.sort((a,b)=> parsePrice(a.price) - parsePrice(b.price));

    gridEl.innerHTML = '';
    emptyEl.style.display = filtered.length ? 'none' : 'block';

    for(const item of filtered){ gridEl.appendChild(cardEl(item)); }
    enableDragReorder();
  }

  function cardEl(item){
    const card = document.createElement('article'); card.className='card'; card.draggable = true;
    card.addEventListener('dragstart', (e)=>{ card.classList.add('dragging'); e.dataTransfer.setData('text/plain', item.id); });
    card.addEventListener('dragend', ()=> card.classList.remove('dragging'));

    const img = document.createElement('img');
    img.className='thumb'; img.loading='lazy'; img.alt=item.title||'';
    img.src = item.image || placeholderImage(item.title);
    img.onerror = ()=>{ img.src = placeholderImage(item.title); };
    card.appendChild(img);

    const body = document.createElement('div'); body.className='content';
    const h3 = document.createElement('div'); h3.style.fontWeight='800'; h3.style.fontSize='1.05rem';
    if(item.link){ const a=document.createElement('a'); a.href=item.link; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=item.title||'Untitled'; h3.appendChild(a); }
    else { h3.textContent = item.title || 'Untitled'; }
    body.appendChild(h3);

    const price = document.createElement('div'); price.className='price'; price.textContent=item.price||''; body.appendChild(price);
    if(item.tag){ const tag=document.createElement('span'); tag.className='tag'; tag.textContent=item.tag; body.appendChild(tag); }
    if(item.note){ const p=document.createElement('div'); p.className='note'; p.textContent=item.note; body.appendChild(p); }

    const meta = document.createElement('div'); meta.className='meta';
    const btns = document.createElement('div'); btns.className='btns';

    const like = document.createElement('div'); like.className='like'; like.title='Like'; like.textContent = `‚ù§Ô∏è ${item.likes||0}`;
    like.onclick = async () => { await supabase.from('items').update({ likes: (item.likes||0)+1 }).eq('id', item.id); };
    meta.appendChild(like);

    const editBtn = document.createElement('button'); editBtn.textContent='Edit';
    editBtn.onclick = async () => {
      const title = prompt('Title:', item.title||''); if(title===null) return;
      const price = prompt('Price:', item.price||''); if(price===null) return;
      const link  = prompt('Link URL:', item.link||''); if(link===null) return;
      const image = prompt('Image URL:', item.image||''); if(image===null) return;
      const note  = prompt('Notes:', item.note||''); if(note===null) return;
      const tag   = prompt('Tag (optional):', item.tag||''); if(tag===null) return;
      await supabase.from('items').update({ title, price, link, image, note, tag }).eq('id', item.id);
    };

    const dupBtn = document.createElement('button'); dupBtn.textContent='Duplicate';
    dupBtn.onclick = async () => {
      const clone = { ...item, id: crypto.randomUUID(), created_at: null, likes:0, position: Date.now() };
      delete clone.created_at;
      await supabase.from('items').insert(clone);
    };

    const delBtn = document.createElement('button'); delBtn.className='btn-danger'; delBtn.textContent='Delete';
    delBtn.onclick = async () => {
      if(!confirm('Delete this card?')) return;
      const { error } = await supabase.from('items').delete().eq('id', item.id);
      if(!error){
        // Optimistic remove to reflect instantly
        const key = (item.category || '').toLowerCase();
        state.items[key] = (state.items[key] || []).filter(i => i.id !== item.id);
        render();
      } else {
        alert('Could not delete: ' + error.message);
      }
    };

    btns.append(editBtn, dupBtn, delBtn); meta.appendChild(btns); body.appendChild(meta); card.appendChild(body); return card;
  }

  function enableDragReorder(){
    gridEl.addEventListener('dragover', (e) => {
      e.preventDefault();
      const dragging = document.querySelector('.card.dragging');
      const afterEl = getDragAfterElement(gridEl, e.clientY);
      if(afterEl == null) gridEl.appendChild(dragging); else gridEl.insertBefore(dragging, afterEl);
    });
    gridEl.addEventListener('drop', async (e) => {
      e.preventDefault();
      const cards = Array.from(gridEl.querySelectorAll('.card'));
      const updates = [];
      for(let i=0;i<cards.length;i++){
        const titleNode = cards[i].querySelector('.content div');
        const title = titleNode.textContent.trim();
        const item = (state.items[currentCat]||[]).find(x => (x.title||'Untitled')===title);
        if(item){ updates.push(supabase.from('items').update({ position: i+1 }).eq('id', item.id)); }
      }
      await Promise.all(updates);
    }, { once:true });
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.card:not(.dragging)')];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if(offset < 0 && offset > closest.offset) return { offset, element: child };
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function clearForm(){ titleEl.value=''; priceEl.value=''; linkEl.value=''; imageEl.value=''; noteEl.value=''; tagEl.value=''; }
  function isValidUrl(u){ try{ new URL(u); return true; } catch{ return false; } }

  function parsePrice(str){
    if(!str) return Number.POSITIVE_INFINITY;
    const m = (str.match(/[\\d.,]+/)||[''])[0].replace(/\\./g,'').replace(',','.');
    const num = parseFloat(m);
    return isNaN(num) ? Number.POSITIVE_INFINITY : num;
  }

  function placeholderImage(seed){
    const s = encodeURIComponent((seed||'Floripa').slice(0,40));
    return `https://source.unsplash.com/600x400/?${s}`;
  }
</script>

</body>
</html>
