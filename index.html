<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viaje Floripa</title>
  <meta name="description" content="Pinboard colaborativo simple para planear un viaje. Agrega autos, hoteles, transporte y planes con t√≠tulo, precio, imagen y enlace. Tablero p√∫blico (sin login)." />
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --line: #e2e8f0;
      --accent: #2563eb;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --shadow: 0 6px 18px rgba(15,23,42,.06);
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-md: 12px;
      --radius-sm: 10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    /* Header con t√≠tulo centrado */
    header{
      position: sticky; top:0; z-index:10;
      background: #ffffffcc;
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--line);
    }
    .wrap{max-width:1000px; margin:0 auto; padding: 16px 18px}
    .topbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
    }
    .logo{
      width:36px; height:36px; border-radius:10px;
      display:grid; place-items:center; font-weight:800; color:#111827;
      background: linear-gradient(135deg, #e0ecff, #dcfce7);
      border:1px solid var(--line);
      justify-self:start;
    }
    .headline{
      justify-self:center;
      font-weight:800;
      letter-spacing:.2px;
      font-size:1.1rem;
    }
    .spacer{justify-self:end;} /* vac√≠o para balancear grid */

    /* Paneles */
    .panel{
      margin:16px auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-xl);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    /* Tabs centradas tipo ‚Äúsegmented control‚Äù */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
      padding: 2px; background:#f1f5f9; border:1px solid var(--line);
      border-radius: 999px; margin-bottom: 12px;
    }
    .tab{
      padding:10px 14px; border-radius:999px; border:1px solid transparent;
      background: transparent; cursor:pointer; font-weight:700; user-select:none; font-size:1rem; color:#0f172a;
      transition: background .15s ease, transform .05s ease;
    }
    .tab[data-id="cars"], .tab[data-id="hotels"], .tab[data-id="transport"]{
      font-size:1.05rem; padding:12px 18px;
    }
    .tab:hover{background:#e2e8f0}
    .tab.active, .tab[aria-selected="true"]{
      background:#ffffff;
      border-color: var(--line);
      box-shadow: 0 1px 0 #fff inset;
    }
    .tab:active{transform:scale(.98)}

    /* Barra de herramientas */
    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .toolbar .left, .toolbar .right{display:flex; gap:10px; flex-wrap:wrap}
    .pill-input{
      display:flex; align-items:center; gap:8px;
      background:#ffffff; border:1px solid var(--line); border-radius:999px; padding:8px 12px;
    }
    .pill-input input{background:transparent; border:none; outline:none; color:var(--text); min-width:160px}
    .pill-input input::placeholder{color:#94a3b8}
    button, .btn{
      appearance:none; border:1px solid var(--line); background:#ffffff;
      color:var(--text); padding:9px 12px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    button:hover,.btn:hover{background:#f8fafc}
    .btn-primary{
      border-color: #c7d2fe;
      background: linear-gradient(180deg, #f0f7ff, #e6ffef);
    }
    .btn-danger{border-color:#fecaca; background:#fff1f2; color:#991b1b}

    /* Formulario */
    .form{display:grid; grid-template-columns: repeat(2, minmax(200px, 1fr)); gap:10px; margin-top:10px}
    .form .wide{grid-column: 1 / -1}

    /* Grid & Cards */
    .grid{
      display:grid; grid-template-columns: repeat( auto-fill, minmax(240px, 1fr) ); gap:14px;
    }
    .card{
      position:relative; overflow:hidden; border-radius: var(--radius-lg);
      background: var(--card); border:1px solid var(--line);
      box-shadow: var(--shadow);
    }
    .thumb{width:100%; aspect-ratio: 16/10; background:#f1f5f9; display:block; object-fit:cover}
    .content{padding:12px 14px}
    .h3{font-weight:800; font-size:1.02rem; line-height:1.2}
    .price{font-weight:800; font-size:1rem; margin-top:6px}
    .note{color:var(--muted); font-size:.92rem; margin-top:6px}
    .meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px}
    .like{cursor:pointer; user-select:none}
    .tag{font-size:.78rem; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#334155; border:1px solid #c7d2fe}

    .empty{color:var(--muted); text-align:center; padding:22px}
    .footer{color:var(--muted); font-size:.9rem; text-align:center; margin:26px 0}

    @media (max-width:640px){
      .form{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="logo" aria-hidden="true">‚úà</div>
      <div class="headline" aria-label="T√≠tulo del tablero">Viaje Floripa</div>
      <div class="spacer" aria-hidden="true"></div>
    </div>
  </header>

  <main class="wrap">
    <!-- Panel de tabs -->
    <section class="panel">
      <nav class="tabs" id="tabs" aria-label="Categor√≠as"></nav>

      <div class="toolbar" aria-label="Filtros y acciones">
        <div class="left">
          <div class="pill-input"><span>üîé</span><input id="search" placeholder="Buscar por t√≠tulo o nota‚Ä¶"></div>
          <button class="btn" id="sortPrice" title="Ordenar por precio">Ordenar: Precio</button>
          <button class="btn" id="sortTitle" title="Ordenar por t√≠tulo">Ordenar: T√≠tulo</button>
        </div>
        <div class="right">
          <button class="btn btn-primary" id="demoBtn" title="Cargar algunas tarjetas de ejemplo">Cargar demo</button>
          <button class="btn btn-danger" id="clearBtn" title="Eliminar todas las tarjetas">Borrar todo</button>
        </div>
      </div>

      <!-- Formulario de alta -->
      <section class="form" id="addForm" aria-label="Agregar tarjeta">
        <label class="pill-input"><span>üìù</span><input id="title" placeholder="T√≠tulo (p. ej., Fiat Argo, Hotel XYZ)" /></label>
        <label class="pill-input"><span>üí≤</span><input id="price" placeholder="Precio (p. ej., R$ 210/d√≠a)" /></label>
        <label class="pill-input wide"><span>üîó</span><input id="link" placeholder="Enlace (https://‚Ä¶)" /></label>
        <label class="pill-input wide"><span>üñºÔ∏è</span><input id="image" placeholder="URL de imagen (https://‚Ä¶)" /></label>
        <label class="pill-input wide"><span>üóíÔ∏è</span><input id="note" placeholder="Notas (opcional)" /></label>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <button class="btn" id="addBtn">Agregar a <span id="addCatLabel"></span></button>
          <label class="pill-input"><span>üè∑Ô∏è</span><input id="tag" placeholder="Etiqueta (opcional: reembolsable, 4pax)"></label>
        </div>
      </section>
    </section>

    <!-- Grid de tarjetas -->
    <section class="panel" aria-live="polite">
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none">Todav√≠a no hay nada. Agreg√° tu primera tarjeta arriba ‚ú®</div>
    </section>

    <div class="footer">Hecho para amigos planificando un viaje a Floripa.</div>
  </main>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // ‚¨áÔ∏è TUS CREDENCIALES (no se tocan)
  const SUPABASE_URL = 'https://sgoegodfbqicmllblllq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnb2Vnb2RmYnFpY21sbGJsbGxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MTMyNDUsImV4cCI6MjA3ODA4OTI0NX0.X2v2WGewNrz5UWipDhYU51lNWyIFueSs-y3jipDx3SA';

  // Tablero p√∫blico (sin login)
  const BOARD_ID = 'viaje-floripa';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const DEFAULT_CATEGORIES = [
    { id:'cars', name:'Autos' },
    { id:'hotels', name:'Hoteles' },
    { id:'transport', name:'Transporte a Florian√≥polis' },
    { id:'plans', name:'Planes e ideas' },
  ];

  // ====== Referencias UI ======
  const tabsEl = document.getElementById('tabs');
  const gridEl = document.getElementById('grid');
  const emptyEl = document.getElementById('empty');

  const titleEl = document.getElementById('title');
  const priceEl = document.getElementById('price');
  const linkEl  = document.getElementById('link');
  const imageEl = document.getElementById('image');
  const noteEl  = document.getElementById('note');
  const tagEl   = document.getElementById('tag');

  const addBtn = document.getElementById('addBtn');
  const addCatLabel = document.getElementById('addCatLabel');

  const searchEl = document.getElementById('search');
  const sortPriceBtn = document.getElementById('sortPrice');
  const sortTitleBtn = document.getElementById('sortTitle');

  const demoBtn = document.getElementById('demoBtn');
  const clearBtn = document.getElementById('clearBtn');

  // ====== Estado ======
  let state = { categories: DEFAULT_CATEGORIES, items: { cars:[], hotels:[], transport:[], plans:[] } };
  let currentCat = 'cars';
  let searchQuery = '';
  let sortMode = null; // 'price' | 'title' | null

  // ====== Init ======
  renderTabs();
  await initialLoad();
  subscribeRealtime();

  // ====== Handlers ======
  addBtn.addEventListener('click', async () => {
    const item = toRow({
      category: currentCat,
      title: titleEl.value.trim(),
      price: priceEl.value.trim(),
      link: linkEl.value.trim(),
      image: imageEl.value.trim(),
      note: noteEl.value.trim(),
      tag: tagEl.value.trim()
    });
    if(!item.title){ alert('A√±ad√≠ un t√≠tulo'); return; }
    if(item.image && !isValidUrl(item.image)){
      if(!confirm('La URL de imagen parece inv√°lida. ¬øAgregar igual?')) return;
    }
    if(item.link && !isValidUrl(item.link)){
      if(!confirm('El enlace parece inv√°lido. ¬øAgregar igual?')) return;
    }
    const { error } = await supabase.from('items').insert(item);
    if(error){ alert('No se pudo agregar: ' + error.message); return; }
    clearForm();
  });

  searchEl.addEventListener('input', () => { searchQuery = searchEl.value.toLowerCase(); render(); });
  sortPriceBtn.addEventListener('click', () => { sortMode = 'price'; render(); });
  sortTitleBtn.addEventListener('click', () => { sortMode = 'title'; render(); });

  demoBtn.addEventListener('click', async () => {
    if(!confirm('¬øCargar tarjetas de DEMO en el tablero COMPARTIDO?')) return;
    const sample = [
      {category:'cars', title:'Fiat Argo (Localiza)', price:'R$ 210/d√≠a', link:'https://www.localiza.com/'},
      {category:'cars', title:'Chevrolet Onix (Movida)', price:'R$ 230/d√≠a', link:'https://www.movida.com.br/'},
      {category:'hotels', title:'Jurer√™ Hotel', price:'R$ 680/noche', link:'#'},
      {category:'transport', title:'Vuelos MVD‚ÜíFLN (AZUL)', price:'US$ 350 ida', link:'#'},
      {category:'plans', title:'Praia Mole', price:'gratis', link:'#'},
    ].map(toRow);
    await supabase.from('items').insert(sample);
  });

  clearBtn.addEventListener('click', async () => {
    if(confirm('¬øEliminar TODAS las tarjetas del tablero COMPARTIDO?')){
      await supabase.from('items').delete().eq('board_id', BOARD_ID);
    }
  });

  // ====== Data layer ======
  function toRow(x){
    return {
      id: crypto.randomUUID(),
      board_id: BOARD_ID,
      category: (x.category||'cars').toLowerCase(),
      title: (x.title||'').trim(),
      price: (x.price||'').trim(),
      link: (x.link||'').trim(),
      image: (x.image||'').trim(),
      note: (x.note||'').trim(),
      tag: (x.tag||'').trim(),
      likes: x.likes ?? 0,
      position: x.position ?? Date.now()
    };
  }

  async function initialLoad(){
    const { data, error } = await supabase
      .from('items')
      .select('*')
      .eq('board_id', BOARD_ID)
      .order('category', { ascending: true })
      .order('position', { ascending: true })
      .order('created_at', { ascending: true });
    if(error){ console.error(error); return; }
    state.items = { cars:[], hotels:[], transport:[], plans:[] };
    for(const r of data){ (state.items[(r.category||'').toLowerCase()] ||= []).push(r); }
    render();
  }

  // Realtime (filtrado en cliente por board_id)
  function subscribeRealtime(){
    supabase
      .channel('items')
      .on('postgres_changes', { event:'*', schema:'public', table:'items' }, payload => {
        const row = payload.new ?? payload.old;
        if(row?.board_id !== BOARD_ID) return;
        applyChange(payload);
        render();
      })
      .subscribe();
  }

  function applyChange({ new: nv, old: ov }){
    if(ov){
      const ok = (ov.category||'').toLowerCase();
      state.items[ok] = (state.items[ok]||[]).filter(i => i.id !== ov.id);
    }
    if(nv){
      const nk = (nv.category||'').toLowerCase();
      const arr = (state.items[nk] ||= []);
      const i = arr.findIndex(x => x.id === nv.id);
      if(i>-1) arr[i] = nv; else arr.push(nv);
      arr.sort((a,b)=> (a.position||0)-(b.position||0) || (new Date(a.created_at)-new Date(b.created_at)));
    }
  }

  // ====== UI ======
  function renderTabs(){
    tabsEl.innerHTML = '';
    state.categories.forEach(cat => {
      const el = document.createElement('button');
      el.className = 'tab' + (cat.id===currentCat ? ' active':'' );
      el.textContent = cat.name;
      el.dataset.id = cat.id;
      el.setAttribute('aria-selected', String(cat.id===currentCat));
      tabsEl.appendChild(el);
    });
    if(!tabsEl.__bound){
      tabsEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.tab');
        if(!btn) return;
        const id = btn.dataset.id;
        if(!id || id===currentCat) return;
        currentCat = id;
        for(const b of tabsEl.querySelectorAll('.tab')){
          const isSel = b.dataset.id===currentCat;
          b.classList.toggle('active', isSel);
          b.setAttribute('aria-selected', String(isSel));
        }
        addCatLabel.textContent = state.categories.find(c=>c.id===currentCat)?.name || '';
        render();
      });
      tabsEl.__bound = true;
    }
    addCatLabel.textContent = state.categories.find(c=>c.id===currentCat)?.name || '';
  }

  function render(){
    const items = [...(state.items[currentCat]||[])];
    const filtered = items.filter(x =>
      !searchQuery ||
      (x.title||'').toLowerCase().includes(searchQuery) ||
      (x.note||'').toLowerCase().includes(searchQuery)
    );
    if(sortMode==='title') filtered.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
    if(sortMode==='price') filtered.sort((a,b)=> parsePrice(a.price) - parsePrice(b.price));

    gridEl.innerHTML = '';
    emptyEl.style.display = filtered.length ? 'none' : 'block';

    for(const item of filtered){ gridEl.appendChild(cardEl(item)); }
  }

  function cardEl(item){
    const card = document.createElement('article'); card.className='card';

    const img = document.createElement('img');
    img.className='thumb'; img.loading='lazy'; img.alt=item.title||'';
    img.src = item.image || placeholderImage(item.title);
    img.onerror = ()=>{ img.src = placeholderImage(item.title); };
    card.appendChild(img);

    const body = document.createElement('div'); body.className='content';
    const h3 = document.createElement('div'); h3.className='h3';
    if(item.link){ const a=document.createElement('a'); a.href=item.link; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=item.title||'Sin t√≠tulo'; h3.appendChild(a); }
    else { h3.textContent = item.title || 'Sin t√≠tulo'; }
    body.appendChild(h3);

    if(item.price){ const price = document.createElement('div'); price.className='price'; price.textContent=item.price; body.appendChild(price); }
    if(item.tag){ const tag=document.createElement('span'); tag.className='tag'; tag.textContent=item.tag; body.appendChild(tag); }
    if(item.note){ const p=document.createElement('div'); p.className='note'; p.textContent=item.note; body.appendChild(p); }

    const meta = document.createElement('div'); meta.className='meta';
    const like = document.createElement('div'); like.className='like'; like.title='Me gusta'; like.textContent = `‚ù§Ô∏è ${item.likes||0}`;
    like.onclick = async () => { await supabase.from('items').update({ likes: (item.likes||0)+1 }).eq('id', item.id); };

    const actions = document.createElement('div');

    const editBtn = document.createElement('button'); editBtn.textContent='Editar';
    editBtn.onclick = async () => {
      const title = prompt('T√≠tulo:', item.title||''); if(title===null) return;
      const price = prompt('Precio:', item.price||''); if(price===null) return;
      const link  = prompt('URL del enlace:', item.link||''); if(link===null) return;
      const image = prompt('URL de la imagen:', item.image||''); if(image===null) return;
      const note  = prompt('Notas:', item.note||''); if(note===null) return;
      const tag   = prompt('Etiqueta (opcional):', item.tag||''); if(tag===null) return;
      await supabase.from('items').update({ title, price, link, image, note, tag }).eq('id', item.id);
    };

    const delBtn = document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.textContent='Eliminar';
    delBtn.onclick = async () => {
      if(!confirm('¬øEliminar esta tarjeta?')) return;
      const { error } = await supabase.from('items').delete().eq('id', item.id);
      if(error){ alert('No se pudo eliminar: ' + error.message); }
    };

    actions.append(editBtn, delBtn);
    meta.append(like, actions);
    body.appendChild(meta);
    card.appendChild(body);
    return card;
  }

  function clearForm(){ titleEl.value=''; priceEl.value=''; linkEl.value=''; imageEl.value=''; noteEl.value=''; tagEl.value=''; }
  function isValidUrl(u){ try{ new URL(u); return true; } catch{ return false; } }

  function parsePrice(str){
    if(!str) return Number.POSITIVE_INFINITY;
    const m = (str.match(/[\d.,]+/)||[''])[0].replace(/\./g,'').replace(',','.');
    const num = parseFloat(m);
    return isNaN(num) ? Number.POSITIVE_INFINITY : num;
  }

  function placeholderImage(seed){
    const s = encodeURIComponent((seed||'Floripa').slice(0,40));
    return `https://source.unsplash.com/600x400/?${s}`;
  }
</script>
</body>
</html>
